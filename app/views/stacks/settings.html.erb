<%= render partial: "stacks/header", locals: { stack: @stack } %>

<div class="wrapper">
  <section>
    <header class="section-header">
      <h2>Settings</h2>
    </header>
    <div class="setting-section">
      <%= form_for @stack do |f| %>
        <p>Checklist (Leave a blank line between items, HTML &lt;a&gt; and &lt;strong&gt; elements are authorized)</p>
        <p><%= f.text_area :checklist %></p>
        <p>Deploy URL (Where is this stack deployed to?)</p>
        <p><%= f.text_field :deploy_url, placeholder: 'https://' %></p>
        <p>Continuous Deployment? <%= f.check_box :continuous_deployment %></p>
        <p><%= f.submit class: "btn" %></p>
      <%- end -%>
    </div>
    <div class="setting-section">
      <h5>Lock deploys</h5>
      <%= form_for @stack do |f| %>
        <% if @stack.lock_reason.present? %>
          <p><%= f.hidden_field :lock_reason, value: nil %></p>
          <p>Deploys are currently locked: <%= @stack.lock_reason %></p>
          <p><%= f.submit class: "btn", value: "Unlock" %></p>
        <% else %>
          <p>Please enter a reason to lock deploys for this stack</p>
          <p><%= f.text_field :lock_reason %></p>
          <p><%= f.submit class: "btn", value: "Lock" %></p>
        <% end %>
      <%- end -%>
    </div>
    <div class="setting-section">
      <h5>Resynchronize this stack</h5>
      <table>
        <tr>
          <td><%= button_to "Webhooks", sync_webhooks_stack_path(@stack), class: "btn", method: "post" %></td>
          <td>Ensure that all required webhooks have been created.</td>
        </tr>
        <tr>
          <td><%= button_to "Commits", sync_commits_stack_path(@stack), class: "btn", method: "post" %></td>
          <td>Force synchronization of new commits in case webhooks haven't been triggered correctly.</td>
        </tr>
        <tr>
          <td><%= button_to "Refresh statuses", refresh_statuses_stack_path(@stack), class: "btn", method: "post" %></td>
          <td>Force synchronization of last 30 commits CI status, in case webhooks have been lost or are slow.</td>
        </tr>
        <tr>
          <td><%= button_to "Clear Git Cache", clear_git_cache_stack_path(@stack), class: "btn", method: "post" %></td>
          <td>Delete the local git mirror in case it's in a bad state.</td>
        </tr>
      </table>
    </div>

    <div class="setting-section">
      <h5>Secret environment</h5>

      <% unless @stack.secrets.empty?%>
      <ul>
        <% @stack.secrets.each do |key, secret_value| %>
          <li><span class="secret-key"><%= key %></span><%= link_to 'Delete', stack_secret_path(@stack, key), method: :delete, data: {confirm: 'Are you sure?'} %></li>
        <% end %>
      </ul>
      <% end %>

      <%= form_for :secret, url: stack_secrets_path(@stack) do |f| %>
        <%= f.text_field :key, placeholder: 'key' %>
        <%= f.password_field :secret_value, placeholder: 'value' %>
        <%= f.submit %>
      <% end %>

    </div>

    <div class="setting-section">
      <h5>Stack-Information</h5>
      <p>ID: <%= @stack.id %></p>
    </div>
    <div class="setting-section">
      <h5>Delete this stack</h5>
      <p>This action will delete the stack from Ship it permanently. Be careful.</p>
      <%= button_to "Delete", stack_path(@stack), :class => "btn delete", :method => :delete, :confirm => "Are you sure?" %>
    </div>

  </section>
</div>
